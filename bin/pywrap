#!/usr/bin/env python

import os
import sys
import pywrap.cython as pycy


SETUP_PY = """import os


def configuration(parent_package='', top_path=None):
    from numpy.distutils.misc_util import Configuration
    import numpy

    config = Configuration('.', parent_package, top_path)

    config.add_extension(
        '%(module)s',
        sources=["%(module)s.cpp", "%(filename)s"], #created by cython
        include_dirs=[".", numpy.get_include()],
        define_macros=[("NDEBUG",)],
        extra_compile_args=["-O3"],
        language="c++",
    )
    return config

if __name__ == '__main__':
    from numpy.distutils.core import setup
    setup(**configuration(top_path='').todict())
"""

def make_setup(**kwargs):
    return SETUP_PY % kwargs


if __name__ == "__main__":
    if len(sys.argv) < 2:
        raise Exception("No filename given")

    verbose = 3
    filename = sys.argv[1]

    parts = filename.split(".")
    module = ".".join(parts[:-1])

    pxd_filename = "_" + module + ".pxd"
    pyx_filename = module + ".pyx"

    tmpfile = filename
    header = parts[-1] in ["h", "hh", "hpp"]

    if header:
        tmpfile = filename + ".cc"
        with open(tmpfile, "w") as f:
            f.write(open(filename, "r").read())

    state = pycy.parse(tmpfile, module, verbose)

    output = state.to_pxd()
    if header:
        output = output.replace(tmpfile, filename)
        os.remove(tmpfile)
    open(pxd_filename, "w").write(output)
    if verbose >= 2:
        print("= %s =" % pxd_filename)
        print(output)

    output = state.to_pyx()
    open(pyx_filename, "w").write(output)
    if verbose >= 2:
        print("= %s =" % pyx_filename)
        print(output)

    os.system("cython --cplus %s" % pyx_filename)

    setup = make_setup(filename=filename, module=module)
    open("setup.py", "w").write(setup)
